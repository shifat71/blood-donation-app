// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  DONOR
  REQUESTER
  MODERATOR
  ADMIN
}

enum BloodGroup {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VerificationType {
  AUTO
  MANUAL
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  password          String
  name              String
  role              Role               @default(DONOR)
  isVerified        Boolean            @default(false)
  verificationType  VerificationType?
  emailVerified     Boolean            @default(false)
  otp               String?
  otpExpiry         DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  // Relations
  donorProfile      DonorProfile?
  verificationRequests VerificationRequest[]
  moderatorActions  VerificationRequest[] @relation("ModeratorActions")
  posts             Post[]
  bloodRequests     BloodRequest[]
  acceptedRequests  BloodRequest[]     @relation("AcceptedDonor")
  donorNotifications DonorNotification[]
  
  @@index([email])
  @@index([role])
}

model DonorProfile {
  id                String      @id @default(cuid())
  userId            String      @unique
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  bloodGroup        BloodGroup
  lastDonationDate  DateTime?
  isAvailable       Boolean     @default(true)
  phoneNumber       String?
  address           String?
  studentId         String?
  profilePicture    String?
  currentDistrict   String?     @default("Sylhet")
  department        String?
  session           String?
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@index([bloodGroup])
  @@index([isAvailable])
}

model VerificationRequest {
  id                String              @id @default(cuid())
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  status            VerificationStatus  @default(PENDING)
  idCardImageUrl    String?             // URL to uploaded student ID card
  studentId         String?
  reason            String?             // Rejection reason or notes
  
  moderatorId       String?
  moderator         User?               @relation("ModeratorActions", fields: [moderatorId], references: [id])
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  reviewedAt        DateTime?
  
  @@index([userId])
  @@index([status])
  @@index([moderatorId])
}

model Post {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  imageUrl    String
  caption     String?
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  FULFILLED
}

enum NotificationStatus {
  UNREAD
  READ
  CLOSED
}

model BloodRequest {
  id                String        @id @default(cuid())
  requesterName     String
  requesterEmail    String
  requesterPhone    String
  bloodGroup        BloodGroup
  urgency           String        // URGENT, MODERATE, NORMAL
  location          String
  hospitalName      String?
  patientName       String?
  unitsNeeded       Int           @default(1)
  additionalInfo    String?
  status            RequestStatus @default(PENDING)
  
  moderatorId       String?
  moderator         User?         @relation(fields: [moderatorId], references: [id])
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  approvedAt        DateTime?
  acceptedAt        DateTime?
  acceptedDonorId   String?
  acceptedDonor     User?         @relation("AcceptedDonor", fields: [acceptedDonorId], references: [id])

  donorNotifications DonorNotification[]
  
  @@index([status])
  @@index([bloodGroup])
  @@index([createdAt])
}

model DonorNotification {
  id             String             @id @default(cuid())
  donorId        String
  bloodRequestId String
  status         NotificationStatus @default(UNREAD)
  readAt         DateTime?
  acceptedAt     DateTime?
  createdAt      DateTime           @default(now())

  donor          User               @relation(fields: [donorId], references: [id], onDelete: Cascade)
  bloodRequest   BloodRequest       @relation(fields: [bloodRequestId], references: [id], onDelete: Cascade)

  @@unique([donorId, bloodRequestId])
  @@index([status])
  @@index([createdAt])
}
